# Introduction

Lua is a scripting language often used in game engines. It is somewhat similar
to Python, but less advanced. One of the more interesting features it supports
is coroutines. Coroutines are similar to threads in the sense that they each
have their own execution context. They can run separately from each other, but
unlike threads, coroutines cannot run in parallel. Coroutines must be explicitly
resumed in order for them to run, and once they run, they must explicitly yield
to let the caller run again. Every time a resume or yield happens, data can be
passed along, which allows coroutines to communicate with each other.

In this article, we're going to define structural operational semantics for
coroutines in Lua. We'll restrict ourselves to a small subset of Lua in order to
focus on the concept of coroutines. Before we move on to the theory, let's have
a look at an example of Lua code using coroutines.

## Example code

\lstinputlisting[language={[5.0]Lua}]{code.lua}
noscript(
\texttt{co = coroutine.wrap(indec)} only creates the coroutine, it does not
start it. When \texttt{it0=co(false)} is called, the coroutine starts with
\texttt{x=false}. The coroutine then enters the while-loop, and because
\texttt{x=false} the program only executes the line
\texttt{pointer=pointer+delta} which gives the variable \texttt{pointer} the
value 1. When \texttt{coroutine.yield(pointer)} is executed, the coroutine
yields and returns the value from \texttt{pointer}. This gives the varablie
\texttt{it0} the value 1. Then \texttt{it1 = co(false)} will be executed. This
will resume the coroutine with \texttt{x=false}. The coroutine resumes where it
left off, which is in the while-loop. Because \texttt{x} is \texttt{false} the
coroutine will again only execute \texttt{pointer=pointer+delta}, which will
return the coroutine with the value of \texttt{pointer}, which is 2. This will
lead to \texttt{it1=2}. Then the coroutine is resumed with \texttt{true} in the
while-loop. Because it is resumed with \texttt{true}, \texttt{delta = delta *
(-1)} will be executed, giving \texttt{delta} the value of \texttt{-1}. After
this, \texttt{pointer=pointer + delta} will be executed. Lastly, the coroutine
will yield with \texttt{pointer=1}, giving \texttt{it2} the value of \texttt{1}.
)
# Syntax

syntax()

# Semantics

## Values

% We define the usual boolean operations on false() and true()

## State

% TODO: new,merge,def,get,let,set

## Expressions

## Simple rules

semantics(empty)

semantics(comp_1)
semantics(comp_2)

semantics(ass)

semantics(if_true)
semantics(if_false)

semantics(while)

## Function rules

## Coroutine rules

semantics(wrap)

semantics(resume_yield)
semantics(resume_ret)
semantics(resume_nil)

# Analysis
